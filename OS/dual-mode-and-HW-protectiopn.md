# 이중 모드

한 서버를 여러 유저가 사용할 때, 한 유저가 고의적으로든 실수로든 서버에 잘못된 접근을 하여 CPU가 다운될 수 있다. 이를 방지하고 보안성을 높이기 위해 CPU 실행모드를 2가지를 두었는데, 이를 이중 모드(Dual Mode)라고 한다.

- 유저 모드
- 관리자 모드

## 관리자 모드는 특권(privileged)이 주어진다

STOP, RESET 등의 서버에 큰 영향을 끼치고 HW에 직접적으로 접근하는 명령에 대한 권한이 주어지게 된다. 이에 비해 유저 모드는 상대적으로 적은 권한이 주어진다.

## 동작 원리

- 레지스터 내부에 존재하는 flag(CPU의 상태를 나타냄) 비트를 사용
- 예를 들어, 1일 때는 관리자 모드/0일 때는 유저 모드

![dual-mode](https://user-images.githubusercontent.com/97890886/187198149-cadce67b-20dc-47ac-88af-91ce7861949d.png)


> 일반적인 프로그램을 실행할 때, 계속해서 유저 모드와 관리자 모드가 반복되는 구조이다.
> 
1. 유저 모드에서 프로그램을 실행하다가
2. 운영체제 서비스나 HW 관련 이벤트 발생 시 인터럽트로 관리자 모드로 넘어갔다가
3. 인터럽트 루트 실행 후 다시 유저 모드로 돌아온다

이중 모드를 사용하면 사용자가 하드웨어에 직접적으로 접근할 수 없고 무조건 인터럽트를 통해 OS에게 ‘대행’을 요청해야 한다.

- 유저 모드에서 특권 명령을 실행해도 내부 인터럽트로 취급당해 제거된다.
- 남의 파일을 읽는 등의 부적절한 접근도 차단된다.(밑의 메모리 보안 참고)

# 이중 모드를 이용한 하드웨어 보안

유저 모드와 관리자 모드를 플래그를 통해 구분하고, 관리자 모드에게 특권을 부여하여 유저 모드에서는 하드웨어에 접근할 수 없고 운영체제를 통해서만 가능하도록 하였다. 이중 모드를 통한 하드웨어 보안을 더 자세히 알아보자.

- I/O 보안
- 메모리 보안
- CPU 보안

## I/O 보안

> 입출력장치에 대한 특권 명령은 인터럽트를 통한 OS의 대행에 의해서만 수행된다.
> 

IN/OUT 명령 → OS에게 요청(Super mode) → Interrupt에 의해 OS가 대신 처리(ISR) → 다시 복귀(User mode)

## 메모리 보안

> MMU(Memory Managed Unit)
> 

다른 유저의 메모리 혹은 운영체제 영역 메모리에 접근하는 등, 위험하거나 부적절한 접근을 할 경우(segment violation) MMU에 의해 제지당한다.

MMU는 CPU와 메모리를 잇는 Address Bus에 위치하며, base limit을 통해 CPU가 읽어낼 수 있는 메모리의 영역을 제한한다 : user 1의 작업을 수행할 경우, user 1의 메모리 영역만을 읽어낼 수 있도록 한다. user 2나 운영체제 영역에는 접근하지 못하게 한다.

![mmu](https://user-images.githubusercontent.com/97890886/187198258-7c56e2dd-e64c-430f-882f-dd3c4819dbcd.png)


## CPU 보안

> Timer
> 

![cpu_timer](https://user-images.githubusercontent.com/97890886/187198314-4667da55-a52b-48ea-9c36-fb0e5d7729ce.png)


실수나 고의로 한 유저/프로세스가 CPU를 독점하게 되는 경우를 대비하여 Timer를 사용한다. 일정 시간마다 인터럽트를 걸어 OS에서 이를 체크 후, 적절히 다른 프로세스로 전환한다.